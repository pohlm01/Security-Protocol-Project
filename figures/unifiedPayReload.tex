\resetstep
\begin{sequencediagram}
    \newthread[white]{t}{t:\emph{Terminal}}
    \newinst[6]{c}{c:Smart Card}

    \stepcounter{seqlevel}
    \begin{call}
        {t}{\shortstack[l]{\nextstep \label{seq:askAmount} If reload \{Ask the user which amount to load on the card and collect money\}\\~~~~else if POS \{get amount from cash desk\}}}
        {t}{}
    \end{call}
    \begin{call}
        {t}{\nextstep \label{seq:increaseTerminalCounter} \eepromt{counter$_t$} += 1}
        {t}{}
    \end{call}

    \begin{call}
        {t}{\nextstep \label{seq:SendTerminalCounter} \eepromt{$\textrm{Cert}^b_t$}, \eepromt{counter$_t$}, \ramt{timestamp}}
        {c}{\shortstack[l]{\nextstep \label{seq:SendCount} \ramt{$\textrm{Cert}^b_c$}, \ramt{counter$_c$}, \ramt{$S_1$}$ = \textrm{Sign}_{k_c}$(\eepromt{counter$_t$} $\|$\\~~~~\eepromt{terminal ID} $\|$ \eepromt{$\textrm{Cert}^b_t$ expiration date}})}
        \addtocounter{seqlevel}{-1}
        \begin{call}
            {c}{\nextstep \label{seq:VerifTerminalCert} verify \ramc{\eepromt{$\textrm{Cert}^b_t$}}}
            {c}{}
        \end{call}
        \begin{call}
            {c}{\nextstep \label{seq:FirstIncreaseCount} \eepromc{counter$_c$} += 1}
            {c}{}
        \end{call}
        \stepcounter{seqlevel}
        \begin{call}
            {c}{\shortstack[l]{\nextstep \label{seq:changeState} If reload \{\ramc{state} = RELOAD\}\\~~~~else if POS \{\ramc{state} = POS\}}}
            {c}{}
        \end{call}
        \addtocounter{seqlevel}{-1}
    \end{call}

% \stepcounter{seqlevel} % introduce some space between messages
    \begin{call}
        {t}{\nextstep
        \label{seq:VerifCardCert}
        verify \ramt{$\textrm{Cert}^b_c$}}
        {t}{}
    \end{call}
    \begin{call}
        {t}{\nextstep \label{seq:VerifChallange} $\textrm{Verif}_{K_c}($\ramt{$S_1$}, \eepromt{counter$_t$} $\|$ \eepromt{terminal ID} $\|$ \eepromt{$\textrm{Cert}^b_t$ expiration date})}
        {t}{}
    \end{call}

    

    \begin{call}
        {t}{~~~~~~~~\nextstep \label{seq:sendAmount} \ramt{amount}, $S_2 = \textrm{Sign}_{k_t}$(\ramt{counter$_c$} $\|$ \ramt{amount} $\|$ \ramt{card ID})}
        {c}{\shortstack[l]{\nextstep \label{seq:s3} $S_3 = \textrm{Sign}_{k_c}$(\ramt{timestamp} $\|$ \ramt{counter$_c$} $\|$\\~~~~~\ramt{amount} $\|$ \ramt{card ID} $\|$ \eepromt{terminal ID})}}
        \begin{call}
            {c}{\nextstep \label{seq:VerifCounter} $\textrm{Verif}_{K_t}($\ramc{$S_2$}, \eepromc{\ramt{counter$_c$}} $\|$ \ramc{\ramt{amount}} $\|$ \eepromc{\ramt{card ID}})}
            {c}{}
        \end{call}
        \begin{call}
            {c}{\nextstep \label{seq:amountPositiv} check \ramc{\ramt{amount}} $> 0$}
            {c}{}
        \end{call}
        \begin{call}
            {c}{\nextstep \eepromc{\ramt{counter$_c$}} += 1}
            {c}{}
        \end{call}
        \stepcounter{seqlevel} % introduce some space between messages
        \begin{call}
            {c}{\shortstack[l]{\nextstep \label{seq:alterBalance} If reload \{\eepromc{balance} += amount\}\\~~~~~else if POS \{\eepromc{balance} -= amount\}}}
            {c}{}
        \end{call}
        \addtocounter{seqlevel}{-1}
    \end{call}
    
    \begin{call}
        {t}{\nextstep \label{seq:verifS3} $\textrm{Verif}_{K_c}(S_3$, \ramt{timestamp} $\|$ \ramt{counter$_c$} $\|$ \ramt{amount} $\|$ \ramt{card ID} $\|$ \eepromt{terminal ID})}
        {t}{}
    \end{call}
    
    \begin{call}
        {t}{\nextstep \label{seq:Log} log(\ramt{timestamp}, \ramt{counter$_c$}, \ramt{amount}, \ramt{card certificate}, \ramt{$S_3$})}
        {t}{}
    \end{call}
    
    \begin{call}
        {t}{\nextstep \label{seq:ShowSuccess} If terminal has display \{Display ``Payment Done''\}}
        {t}{}
    \end{call}
\end{sequencediagram}