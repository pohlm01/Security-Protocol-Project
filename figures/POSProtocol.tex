\resetstep
\begin{sequencediagram}
    \newthread[white]{p}{p:POS Terminal}
    \newinst[6]{c}{c:Smart Card}

    \begin{call}
        {p}{mutual authentication as described in Figure~\ref{fig:MutualAuth}}
        {c}{}
    \end{call}
    
    \stepcounter{seqlevel}

    \begin{call}
        {p}{\nextstep \label{seq:POSaskAmount} Get amount from cash desk}
        {p}{}
    \end{call}

    \begin{call}
        {p}{\nextstep \label{seq:POSSendAmount} amount}
        {c}{}
        \addtocounter{seqlevel}{-1}
        \begin{call}
            {c}{\nextstep \label{seq:POSamountPositiv} check \ramc{amount} $> 0$ and save it}
            {c}{}
        \end{call}
        \begin{call}
            {c}{\nextstep \label{seq:POSStateConfirmPending} \ramc{state} = \texttt{POS\_AMOUNT\_AUTHENTICATED}}
            {c}{}
        \end{call}
        \addtocounter{seqlevel}{-1}
    \end{call}

    \begin{call}
        {p}{\nextstep \label{seq:POSsendAmount} $S_2 = \textrm{Sign}_{k_p}$(\ramt{counter$_c$} $\|$ \ramt{amount} $\|$ \ramt{ID$_c$})}
        {c}{\nextstep \label{seq:POSs3} $S_3 = \textrm{Sign}_{k_c}$(\ramt{TS} $\|$ \ramt{counter$_c$} $\|$ \ramt{amount} $\|$ \ramt{ID$_c$} $\|$ \eepromt{ID$_p$})}
        
        \begin{call}
            {c}{\nextstep \label{seq:POSVerifCounter} $\textrm{Verif}_{K_p}($\ramc{$S_2$}, \eepromc{\ramt{counter$_c$}} $\|$ \ramc{\ramt{amount}} $\|$ \eepromc{\ramt{ID$_c$}})}
            {c}{}
        \end{call}
        
        \begin{call}
            {c}{\nextstep \label{seq:POSSecondIncreaseCounter}\eepromc{\ramt{counter$_c$}} += 1}
            {c}{}
        \end{call}

        \begin{call}
            {c}{\nextstep \label{seq:POSalterBalance} \eepromc{balance} -= amount}
            {c}{}
        \end{call}

        \begin{call}
            {c}{\nextstep \label{seq:POSStateFinish} \ramc{state} = \texttt{FINISHED}}
            {c}{}
        \end{call}
        
        \addtocounter{seqlevel}{-1}
    \end{call}
    
    \begin{call}
        {p}{\nextstep \label{seq:POSverifS3} $\textrm{Verif}_{K_c}(S_3$, TS $\|$ counter$_c$ $\|$ amount $\|$ ID$_c$ $\|$ ID$_p$)}
        {p}{}
    \end{call}
    
    \begin{call}
        {p}{\nextstep \label{seq:POSLog} log(TS, counter$_c$, amount, K$_c$, ID$_c$, $S_3$)}
        {p}{}
    \end{call}


    \begin{call}
        {p}{\nextstep \label{seq:POSShowSuccess} If terminal has display \{Display ``Payment Done''\}}
        {p}{}
    \end{call}
\end{sequencediagram}